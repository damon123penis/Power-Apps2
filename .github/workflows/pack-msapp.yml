name: Repack Canvas App from baseline msapp

on:
  workflow_dispatch:

jobs:
  repack:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install pac (pinned)
        shell: pwsh
        run: |
          dotnet tool install --global Microsoft.PowerApps.CLI.Tool --version 2.0.1
          echo "$env:USERPROFILE\.dotnet\tools" >> $env:GITHUB_PATH
          pac help | Out-Null

      - name: Unpack baseline msapp to sources
        shell: pwsh
        run: |
          if (Test-Path "./work") { Remove-Item "./work" -Recurse -Force }
          New-Item -ItemType Directory -Path "./work/src" | Out-Null
          pac canvas unpack --msapp "./baseline/LE-App.msapp" --sources "./work/src"

      - name: Apply patched screens
        shell: pwsh
        run: |
          Copy-Item "./patch/Src/Validierungen.pa.yaml" "./work/src/Src/Validierungen.pa.yaml" -Force
          Copy-Item "./patch/Src/LE_Checkliste.pa.yaml" "./work/src/Src/LE_Checkliste.pa.yaml" -Force

      - name: Validate
        shell: pwsh
        run: |
          pac canvas validate --directory "./work/src"

      - name: Pack new msapp
        shell: pwsh
        run: |
          pac canvas pack --sources "./work/src" --msapp "./LE-App_patched.msapp"

      - uses: actions/upload-artifact@v4
        with:
          name: LE-App_patched-msapp
          path: ./LE-App_patched.msapp